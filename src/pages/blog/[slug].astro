---
import Layout from "@layouts/Layout.astro";
import { getAllPostsSlugs, getPostsInfo } from "@lib/wp";
import ChapterNavButton from "@components/ui/ChapterNavButton.astro";

const slug = Astro.params.slug;
if (!slug) {
  throw new Error("Slug is required");
}

const {
  title,
  date,
  content,
  excerpt,
  featuredImage,
  alt_text_image,
  authorName,
  authorAvatar,
  authorDescription,
  isFirst,
  isLast,
  prevSlug,
  nextSlug,
  prevTitle,
  nextTitle,
} = await getPostsInfo(slug);

export async function getStaticPaths() {
  const slugs: string[] = await getAllPostsSlugs();
  return slugs.map((slug: string) => ({ params: { slug } }));
}
const dateFormatted = new Date(date).toLocaleDateString("es-ES", {
  year: "numeric",
  month: "2-digit",
  day: "2-digit",
  hour12: false,
});
---

<Layout
  title={title}
  description={excerpt ||
    "Blog sobre mi propio One Piece. En bÃºsqueda de mi libertad."}
  ogimage={featuredImage}
>
  <div
    id="reading-progress"
    class="fixed top-0 left-0 h-1 bg-[var(--primary)] z-50 w-0"
  >
  </div>
  <main class="pt-8 pb-16 lg:pt-8 lg:pb-24 antialiased">
    <article class="prose prose-lg mx-auto max-w-3xl px-2">
      <div
        class="rounded-[1.25rem] sm:rounded-2xl px-5 py-7 sm:px-9 sm:py-10 bg-gradient-to-b from-[rgba(250,239,236,0.96)] to-[rgba(250,239,236,0.92)] shadow-[0_10px_25px_rgba(58,31,26,0.08),inset_0_0_0_1px_rgba(196,138,125,0.25)]"
      >
        <h1 class="text-4xl font-extrabold tracking-tight mb-6 text-center">
          {title}
        </h1>

        {
          featuredImage && (
            <figure class="my-8 mb-14">
              <picture>
                <img
                  src={featuredImage}
                  alt={alt_text_image}
                  title={alt_text_image}
                  class="w-full h-auto object-cover rounded-xl shadow-md"
                  loading="lazy"
                />
              </picture>
              {excerpt && (
                <figcaption class="mt-2 text-xs text-gray-500 italic text-center">
                  {excerpt}
                </figcaption>
              )}
            </figure>
          )
        }

        <div
          class="prose prose-lg max-w-none
         font-sans
         text-[1.1rem] sm:text-[1.125rem]
         leading-[1.85]
         tracking-[0.005em]
         text-[var(--foreground)]
         [&_p]:mb-[1.7em]
         [&_strong]:font-semibold"
          set:html={content}
        />

        <p class="text-sm text-gray-500 mt-12 justify-end text-right">
          Publicado el <span class="font-semibold">{dateFormatted}</span>
        </p>

        <div class="border-t border-gray-200 pt-4 pb-8">
          <ChapterNavButton
            prevSlug={prevSlug}
            prevTitle={prevTitle}
            nextSlug={nextSlug}
            nextTitle={nextTitle}
            isFirst={isFirst}
            isLast={isLast}
          />
        </div>
      </div>

      <footer class="max-w-3xl w-full mx-auto mt-5">
        <div
          class="w-full flex items-center justify-between gap-2 px-6 border border-gray-200 shadow-md rounded-xl bg-white"
        >
          <div class="flex-shrink-0 justify-end border-r pr-6">
            <img
              class="object-cover w-24 h-24 rounded-full ring-2 ring-primary-200"
              src={authorAvatar}
              alt={authorName}
              loading="lazy"
            />
          </div>

          <div
            class="w-full flex flex-col justify-start items-start ml-4 mr-0 p-0 my-auto"
          >
            <h3 class="text-lg font-semibold">{authorName}</h3>
            <p class="text-sm text-gray-600">{authorDescription}</p>
          </div>
        </div>
      </footer>
    </article>
  </main>

  <script>
    document.addEventListener("scroll", () => {
      const doc = document.documentElement;
      const progress =
        (doc.scrollTop / (doc.scrollHeight - doc.clientHeight)) * 100;
      const bar = document.getElementById("reading-progress");
      if (bar) bar.style.width = `${progress}%`;
    });
  </script>
</Layout>
