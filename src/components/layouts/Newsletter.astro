---
interface Props {
  title?: string;
  description?: string;
  placeholder?: string;
  buttonText?: string;
}

const {
  title = "Mantente conectado",
  description = "Suscríbete para recibir ideas exclusivas, adelantos de capítulos y actualizaciones.",
  placeholder = "Introduce tu correo",
  buttonText = "Suscribirse",
} = Astro.props;
---

<section class="py-20 px-4 bg-[var(--primary)]/20">
  <div class="max-w-2xl mx-auto text-center">
    <h2 class="text-3xl md:text-4xl font-bold mb-4">{title}</h2>
    <p class="text-[var(--muted-foreground)] mb-8">{description}</p>

    <form
      id="newsletter-form"
      class="flex flex-col sm:flex-row gap-4 max-w-md mx-auto"
    >
      <input
        type="email"
        name="email"
        placeholder={placeholder}
        required
        class="flex-1 w-full border border-[var(--border)] px-4 py-2 rounded-lg focus:ring-2 focus:ring-[var(--primary)]"
      />
      <button
        type="submit"
        class="w-full sm:w-auto bg-[var(--primary)] text-[var(--primary-foreground)] px-6 py-2 rounded-lg active:scale-95 transition"
      >
        {buttonText}
      </button>
    </form>

    <p id="newsletter-message" class="mt-4 text-sm hidden"></p>
  </div>
</section>

<script>
  document
    .getElementById("newsletter-form")
    ?.addEventListener("submit", async function (e) {
      e.preventDefault();

      const form = e.target as HTMLFormElement;
      const email = (
        form.querySelector('input[name="email"]') as HTMLInputElement
      ).value;
      const button = form.querySelector(
        'button[type="submit"]'
      ) as HTMLButtonElement;
      const message = document.getElementById(
        "newsletter-message"
      ) as HTMLElement;

      // Estado de carga
      const originalText = button.textContent;
      button.textContent = "Suscribiendo...";
      button.disabled = true;
      message.classList.add("hidden");

      try {
        const response = await fetch("/api/newsletter-subscribe", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ email }),
        });

        const data = await response.json();

        if (response.ok) {
          // Éxito
          button.textContent = "✅ ¡Suscrito!";
          button.classList.add("bg-green-600");
          message.textContent = data.message || "¡Gracias por suscribirte!";
          message.classList.remove("hidden", "text-red-500");
          message.classList.add("text-green-600");
          form.reset();

          // Resetear después de 3 segundos
          setTimeout(() => {
            button.textContent = originalText;
            button.disabled = false;
            button.classList.remove("bg-green-600");
            message.classList.add("hidden");
          }, 3000);
        } else {
          // Error
          throw new Error(data.error || "Error al suscribirse");
        }
      } catch (error) {
        // Error
        button.textContent = "❌ Error";
        message.textContent =
          error instanceof Error ? error.message : "Error al suscribirse";
        message.classList.remove("hidden", "text-green-600");
        message.classList.add("text-red-500");

        // Resetear después de 3 segundos
        setTimeout(() => {
          button.textContent = originalText;
          button.disabled = false;
        }, 3000);
      }
    });
</script>
