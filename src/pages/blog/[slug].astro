---
import Layout from "@layouts/Layout.astro";
import { getAllPostsSlugs, getPostsInfo } from "@lib/wp";
import ChapterNavButton from "@components/ui/ChapterNavButton.astro";

const slug = Astro.params.slug;
if (!slug) {
  throw new Error("Slug is required");
}

const {
  title,
  date,
  content,
  excerpt,
  featuredImage,
  alt_text_image,
  isFirst,
  isLast,
  prevSlug,
  nextSlug,
  prevTitle,
  nextTitle,
} = await getPostsInfo(slug);

export async function getStaticPaths() {
  const slugs: string[] = await getAllPostsSlugs();
  return slugs.map((slug: string) => ({ params: { slug } }));
}
const dateFormatted = new Date(date).toLocaleDateString("es-ES", {
  year: "numeric",
  month: "2-digit",
  day: "2-digit",
  hour12: false,
});
---

<Layout
  title={title}
  description={excerpt ||
    "Blog sobre mi propio One Piece. En bÃºsqueda de mi libertad."}
  ogimage={featuredImage}
>
  <div
    id="reading-progress"
    class="fixed top-0 left-0 h-1 bg-[var(--primary)] z-50 w-0"
  >
  </div>
  <div class="pt-8 pb-16 lg:pt-8 lg:pb-12 antialiased">
    <article class="prose prose-lg mx-auto max-w-3xl px-2">
      <div
        class="rounded-[1.25rem] sm:rounded-2xl px-5 py-7 sm:px-9 sm:py-10 bg-gradient-to-b from-[rgba(250,239,236,0.96)] to-[rgba(250,239,236,0.92)] shadow-[0_10px_25px_rgba(58,31,26,0.08),inset_0_0_0_1px_rgba(196,138,125,0.25)]"
      >
        <h1 class="text-4xl font-extrabold tracking-tight mb-6 text-center">
          {title}
        </h1>

        {
          featuredImage && (
            <figure class="my-8 mb-14 sm:my-10">
              <picture>
                <img
                  src={featuredImage}
                  alt={alt_text_image}
                  title={alt_text_image}
                  class="w-full h-auto object-cover rounded-xl shadow-md"
                  loading="lazy"
                />
              </picture>
              {excerpt && (
                <figcaption class="mt-2 text-xs text-gray-500 italic text-center">
                  {excerpt}
                </figcaption>
              )}
            </figure>
          )
        }

        <div
          class="prose prose-neutral max-w-none text-[1.05rem] sm:text-[1.125rem] leading-[1.9] tracking-[0.006em] [&_p]:mb-[1.9em] [&_h2]:mt-[2.4em] [&_h3]:mt-[2em] [&_ul]:my-[1.6em] [&_li]:mb-[0.6em] [&_blockquote]:border-l-4 [&_blockquote]:pl-4 [&_blockquote]:italic [&_img]:rounded-xl text-[var(--foreground)]"
          set:html={content}
        />

        <p class="text-sm text-gray-500 mt-12 justify-end text-right">
          Publicado el <span class="font-semibold">{dateFormatted}</span>
        </p>

        <div class="border-t border-gray-200 pt-4 pb-8">
          <ChapterNavButton
            prevSlug={prevSlug}
            prevTitle={prevTitle}
            nextSlug={nextSlug}
            nextTitle={nextTitle}
            isFirst={isFirst}
            isLast={isLast}
          />
        </div>
      </div>
    </article>
  </div>

  <script>
    document.addEventListener("scroll", () => {
      const doc = document.documentElement;
      const progress =
        (doc.scrollTop / (doc.scrollHeight - doc.clientHeight)) * 100;
      const bar = document.getElementById("reading-progress");
      if (bar) bar.style.width = `${progress}%`;
    });
  </script>
</Layout>
